<!DOCTYPE html>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<style>
    /* all css here */
    .cells path {
        fill: none;
        pointer-events: all;
    }

    div.tooltip {
        position: absolute;
        text-align: left;
        font-family: "Roboto", sans-serif;
        white-space: normal;
        padding: 6px;
        font-size: 14px;
        background: #eee;
        border: 1px solid gray;
        border-radius: 2px;
        pointer-events: none;
        cursor: none;
        overflow: visible;
        min-width: 200px;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #aaa;
        shape-rendering: crispEdges;
    }

    .axis text {
        font: 10px sans-serif;
        fill: darkslategray;
    }

    body {
        text-align: center;
        font-family: 'Roboto', sans-serif !important;
        width: 950px;
        margin: 0 auto !important;
    }

    .button1 {
        margin-right: 10px !important;
        background-color: #f5f5f5 !important;
    }

    .button2 {
        background-color: #f5f5f5 !important;
    }
</style>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />

<body>
    <br>
    <div>
        <h2>NYC Public High Schools at a glance</h2>
        <p style="font-size: 18px; display:inline;">
            The graph below visualises data from <spn style="display:inline; font-size: 22px;">440</spn> public high schools under the <a href="http://schools.nyc.gov/default.htm" target="_blank">New York City Department of Education</a>. I myself graduated from one (John Bowne High School) in 2011.
        </p>
        <p>
            See how high schools compare in graduation rate, attendance, enrollment and college career rate across the 5 boroughs.
        </p>
    </div>
    <br />

    <div class="row">
        <div class="col-md-12" style="display:inline;">
            <div class="btn-group" style="float:left;">
                <button type="button" class="button1 btn btn-default" value="graduation_rate">Graduation Rate</button>
                <button type="button" class="button1 btn btn-default" value="attendance_rate">Attendance Rate</button>
                <button type="button" class="button1 btn btn-default" value="total_students">Enrollment</button>
                <button type="button" class="button1 btn btn-default" value="college_career_rate">College Career Rate</button>
            </div>
            <div class="btn-group2" style="float:right;">
                <button type="button" class="button2 btn btn-default" value="scaleLinear">Linear Scale</button>
                <button type="button" class="button2 btn btn-default" value="scaleLog">Log Scale</button>
            </div>
            <div id="graph">

            </div>
            <div id="checkboxes" style="display:inline-block;">
                <span>Click to hide/show:&nbsp;&nbsp;</span>
                <label>
                    <input type="checkbox" name="continent" value="X" checked>Bronx
                    <span id="africaColor" style="font-size:20px;">&bull;&nbsp;&nbsp;</span>
                </label>
                <label>
                    <input type="checkbox" name="continent" value="R" checked>Staten Island
                    <span id="namericaColor" style="font-size:20px;">&bull;&nbsp;&nbsp;</span>
                </label>
                <label>
                    <input type="checkbox" name="continent" value="Q" checked>Queens
                    <span id="samericaColor" style="font-size:20px;">&bull;&nbsp;&nbsp;</span>
                </label>
                <label>
                    <input type="checkbox" name="continent" value="M" checked>Manhattan
                    <span id="asiaColor" style="font-size:20px;">&bull;&nbsp;&nbsp;</span>
                </label>
                <label>
                    <input type="checkbox" name="continent" value="K" checked>Brooklyn
                    <span id="europeColor" style="font-size:20px;">&bull;&nbsp;&nbsp;</span>
                </label>
            </div>
        </div>
    </div>

    <hr />
    <h5>Created by <a href="index.html">Saurav Mohapatra</a></h5>
    <h5>Data Source: <a href="https://data.cityofnewyork.us/Education/DOE-High-School-Directory-2017/s3k6-pzi2">https://data.cityofnewyork.us/Education/DOE-High-School-Directory-2017/s3k6-pzi2</a></h5>
    <h5>Graph inspired by: <a href="https://gf.neocities.org/co2bs/co2bee.html">https://gf.neocities.org/co2bs/co2bee.html</a></h5>
    <br>

    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


    <script src="https://d3js.org/d3.v4.min.js"></script>

    <script type="text/javascript">

        var w = 1000, h = 325;

        var padding = [0, 40, 34, 40];

        var xScale = d3.scaleLinear()
            .range([padding[3], w - padding[1]]);

        var xAxis = d3.axisBottom(xScale)
            .ticks(10, ".0s")
            .tickSizeOuter(0);

        var colors = d3.scaleOrdinal()
            .domain(["bronx", "statenIsland", "queens", "manhattan", "brooklyn"])
            .range(['#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00']);

        d3.select("#africaColor").style("color", colors("bronx"));
        d3.select("#namericaColor").style("color", colors("statenIsland"));
        d3.select("#samericaColor").style("color", colors("queens"));
        d3.select("#asiaColor").style("color", colors("manhattan"));
        d3.select("#europeColor").style("color", colors("brooklyn"));

        var formatNumber = d3.format(",");

        var tt = d3.select("#graph").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        var svg = d3.select("#graph")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        var xline = svg.append("line")
            .attr("stroke", "gray")
            .attr("stroke-dasharray", "1,2");

        var chartState = {};

        chartState.variable = "graduation_rate";
        chartState.scale = "scaleLinear";
        chartState.legend = "Graduation Rate";

        d3.csv("DOE_High_School_Directory_2017.csv", function (error, data) {
            if (error) throw error;

            var dataSet = data;

            xScale.domain(d3.extent(data, function (d) { return +((d.graduation_rate) * 100).toFixed(2); }));

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + (h - padding[2]) + ")")
                .call(xAxis);

            var legend = svg.append("text")
                .attr("text-anchor", "middle")
                .attr("x", w / 2)
                .attr("y", h )
                .attr("font-family", "Roboto")
                .attr("font-size", 15)
                .attr("fill", "darkslategray")
                .attr("fill-opacity", 1)
                .attr("class", "legend");

            redraw(chartState.variable);

            d3.selectAll(".button1").on("click", function () {
                var thisClicked = this.value;
                chartState.variable = thisClicked;
                if (thisClicked == "graduation_rate") {
                    chartState.legend = "Graduation Rate";
                };
                if (thisClicked == "attendance_rate") {
                    chartState.legend = "Attendance Rate";
                }
                if (thisClicked == "total_students") {
                    chartState.legend = "Enrollment";
                }
                if (thisClicked == "college_career_rate") {
                    chartState.legend = "College Career Rate";
                }
                redraw(chartState.variable);
            });

            d3.selectAll(".button2").on("click", function () {
                var thisClicked = this.value;
                chartState.scale = thisClicked;
                redraw(chartState.variable);
            });

            d3.selectAll("input").on("change", filter);

            function redraw(variable) {

                if (chartState.scale == "scaleLinear") { xScale = d3.scaleLinear().range([padding[3], w - padding[1]]); };

                if (chartState.scale == "scaleLog") { xScale = d3.scaleLog().range([padding[3], w - padding[1]]); };

                if (variable !== "total_students") {
                    xScale.domain(d3.extent(dataSet, function (d) { return +(d[variable] * 100).toFixed(2); }));
                } else {
                    xScale.domain(d3.extent(dataSet, function (d) { return +(d[variable]); }));
                }


                var xAxis = d3.axisBottom(xScale)
                    .ticks(10, ".0s")
                    .tickSizeOuter(0);

                d3.transition(svg).select(".x.axis").transition().duration(1000)
                    .call(xAxis);

                var simulation = d3.forceSimulation(dataSet)
                    .force("x", d3.forceX(function (d) {
                        if (variable === "total_students") {
                            return xScale(+(d[variable]));
                        } else {
                            return xScale(+(d[variable] * 100).toFixed(2));
                        }
                    }).strength(2))
                    .force("y", d3.forceY((h / 2) - padding[2] / 2))
                    .force("collide", d3.forceCollide(4))
                    .stop();

                for (var i = 0; i < dataSet.length; ++i) simulation.tick();

                var countriesCircles = svg.selectAll(".countries")
                    .data(dataSet, function (d) { return d.school_name });

                countriesCircles.exit()
                    .transition()
                    .duration(1000)
                    .attr("cx", 0)
                    .attr("cy", (h / 2) - padding[2] / 2)
                    .remove();

                countriesCircles.enter()
                    .append("circle")
                    .attr("class", "countries")
                    .attr("cx", 0)
                    .attr("cy", (h / 2) - padding[2] / 2)
                    .attr("r", 3)
                    .attr("fill", function (d) { return colors(d.boro) })
                    .merge(countriesCircles)
                    .transition()
                    .duration(2000)
                    .attr("cx", function (d) { return d.x; })
                    .attr("cy", function (d) { return d.y; });

                legend.text(chartState.legend);

                function tooltipVal(val) {
                    if (variable !== "total_students") {
                        return (val * 100).toFixed(2) + "%";
                    } else {
                        return val;
                    }
                }

                d3.selectAll(".countries").on("mousemove", function (d) {
                    tt.html("School: <strong>" + d.school_name + "</strong><br>"
                    + chartState.legend + ": <strong>" + tooltipVal(d[variable]) + "</strong>")
                        .style('top', d3.event.pageY - 225 + 'px')
                        .style('left', d3.event.pageX - 270 + 'px')
                        .style("opacity", 0.9);

                    xline.attr("x1", d3.select(this).attr("cx"))
                        .attr("y1", d3.select(this).attr("cy"))
                        .attr("y2", (h - padding[2]))
                        .attr("x2", d3.select(this).attr("cx"))
                        .attr("opacity", 1);

                }).on("mouseout", function (d) {
                    tt.style("opacity", 0);
                    xline.attr("opacity", 0);
                });
            }

            function filter() {

                function getCheckedBoxes(chkboxName) {
                    var checkboxes = document.getElementsByName(chkboxName);
                    var checkboxesChecked = [];
                    for (var i = 0; i < checkboxes.length; i++) {
                        if (checkboxes[i].checked) {
                            checkboxesChecked.push(checkboxes[i].defaultValue);
                        }
                    }
                    return checkboxesChecked.length > 0 ? checkboxesChecked : null;
                }

                var checkedBoxes = getCheckedBoxes("continent");

                var newData = [];

                if (checkedBoxes == null) {
                    dataSet = newData;
                    redraw();
                    return;
                };

                for (var i = 0; i < checkedBoxes.length; i++) {
                    var newArray = data.filter(function (d) {
                        return d.boro == checkedBoxes[i];
                    });
                    Array.prototype.push.apply(newData, newArray);
                }

                dataSet = newData;

                redraw(chartState.variable);
            }
        });



    </script>
</body>